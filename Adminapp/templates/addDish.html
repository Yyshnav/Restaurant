{% extends 'sidebar.html' %}
{% load static %}


{% block body %}
  <style>
    .form-section { margin-bottom: 20px; }
    .printer-field, .variant-field { display: flex; gap: 10px; margin-bottom: 10px; }
    .printer-field input, .variant-field input { flex: 1; }
  </style>



  <!-- Main Content -->
  <div class="app-content content">
    <div class="content-wrapper">
      <div class="content-header row">
        <div class="content-header-left col-md-6 col-12">
          <h3 class="content-header-title text-dark">Add New Dish</h3>
        </div>
      </div>
      <div class="content-body">
        <section>
          <div class="card">
            <div class="card-body">
              <form  method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-section">
                  <label>Dish Name</label>
                  <input type="text" name="name" class="form-control" required>
                </div>

                  <!-- Main Category -->
        <div class="form-section">
          <label>Main Category</label>
          <select name="category" class="form-control" id="mainCategorySelect" required>
            <option value="">Select</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Sub Category -->
        <div class="form-section">
          <label>Sub Category</label>
          <select name="subcategory" class="form-control" id="subCategorySelect" required>
            <option value="">Select Main Category First</option>
          </select>
        </div>

        <!-- Sub-Sub Category -->
        <div class="form-section">
          <label>Sub-Sub Category</label>
          <select name="subsubcategory" class="form-control" id="subSubCategorySelect" >
            <option value="">Select Sub Category First</option>
          </select>
        </div>

                <div class="form-section">
                  <label>Veg / Non-Veg</label>
                  <select name="is_veg" class="form-control" required>
                    <option value="True">Vegetarian</option>
                    <option value="False">Non-Vegetarian</option>
                  </select>
                </div>

                <div class="form-section">
                  <label>Description</label>
                  <textarea name="description" class="form-control" required></textarea>
                </div>

                <div class="form-section">
                  <label>Dish Images</label>
                  <div id="imageUploadContainer">
                    <div class="image-entry d-flex align-items-center mb-2">
                      <input type="file" name="dishImages[]" class="form-control me-2" accept="image/*" required>
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeImage(this)">X</button>
                    </div>
                  </div>
                  <button type="button" class="btn btn-primary btn-sm mt-1" onclick="addImageInput()">+ Add Another Image</button>
                </div>



               <div class="form-section">
                <label>Voice Notes</label>
                <div id="voiceNoteContainer">
                  <div class="voice-note-entry d-flex align-items-start gap-2 mb-2">
                    <div class="flex-grow-1">
                      <select name="voiceLanguages[]" class="form-control mb-1" required>
                        <option value="">Select Language</option>
                        <option value="en">English</option>
                        <option value="ml">Malayalam</option>
                        <option value="hi">Hindi</option>
                        <option value="ar">Arabic</option>
                      </select>
                      <input type="file" name="voiceFiles[]" class="form-control" accept="audio/*" required>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeVoiceNote(this)">X</button>
                  </div>
                </div>
                <button type="button" onclick="addVoiceNote()" class="btn btn-primary btn-sm mt-1">+ Add Voice Note</button>
              </div>


                <div class="form-section">
                  <label>Variants</label>
                  <div id="variantContainer">
                    <div class="variant-field">
                      <input type="text" name="variants[0][name]" placeholder="Variant (e.g., Half)" >
                      <input type="number" name="variants[0][price]" placeholder="Price" step="0.01" >
                      <button type="button" onclick="removeVariant(this)" class="btn btn-danger btn-sm">X</button>
                    </div>
                  </div>
                  <button type="button" onclick="addVariant()" class="btn btn-primary btn-sm mt-1">+ Add Variant</button>
                </div>

                <div class="form-section">
                  <label>Cost</label>
                  <input type="number" name="price" class="form-control" step="0.01" required>
                </div>

                <div class="form-section">
                <label><strong>Add-ons (Optional)</strong></label>
                <div id="addonContainer">
                  <div class="addon-entry d-flex align-items-center mb-2">
                    <input type="text" name="addon_name[]" placeholder="Addon Name" class="form-control me-2" />
                    <input type="number" name="addon_price[]" placeholder="Price" step="0.01" class="form-control me-2" />
                    <input type="file" name="addon_image[]" class="form-control me-2" accept="image/*" />
                    <input type="text" name="addon_description[]" placeholder="Description" class="form-control me-2" />
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeAddon(this)">âœ–</button>
                  </div>
                </div>
                <button type="button" class="btn btn-primary btn-sm mt-1" onclick="addAddon()">+ Add Addon</button>
              </div>

                <div class="form-section"> 
                  <label>Inventory Quantity</label>
                  <input type="number" name="inventory" class="form-control" required>
                </div>
                <div class="form-section">
                  <label>Preparation Time (minutes)</label>
                  <input type="number" name="preparation_time" class="form-control" required>
                </div>

                <!-- Branches -->
                  <div class="form-section">
                    <label>Branches</label><br>
                    {% for branch in branches %}
                    <div class="form-check">
                      <input type="checkbox" name="branches" value="{{ branch.id }}" id="branch{{ forloop.counter }}">
                      <label for="branch{{ forloop.counter }}">{{ branch.name }}</label>
                    </div>
                    {% endfor %}
                  </div>
                    <!-- ADDONS SECTION -->
      


                <!-- New Field for Calories -->
                <div class="form-section">
                  <label>Calories (kcal)</label>
                  <input type="number" name="calories" class="form-control" step="1" min="0" required>
                </div>

                <button type="submit" class="btn btn-success">Submit Dish</button>
              </form>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const mainCategorySelect = document.getElementById('mainCategorySelect');
  const subCategorySelect = document.getElementById('subCategorySelect');
  const subSubCategorySelect = document.getElementById('subSubCategorySelect');

  mainCategorySelect.addEventListener('change', function () {
    const categoryId = this.value;
    subCategorySelect.innerHTML = '<option value="">Loading...</option>';
    subSubCategorySelect.innerHTML = '<option value="">Select Sub Category First</option>';

    fetch(`/get-subcategories/?category_id=${categoryId}`)
      .then(response => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.json();
      })
      .then(data => {
        subCategorySelect.innerHTML = '<option value="">Select</option>';
        data.forEach(item => {
          subCategorySelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
        });
      })
      .catch(error => {
        console.error('Error loading subcategories:', error);
        subCategorySelect.innerHTML = '<option value="">Error loading</option>';
      });
  });

  subCategorySelect.addEventListener('change', function () {
    const subCategoryId = this.value;
    subSubCategorySelect.innerHTML = '<option value="">Loading...</option>';

    fetch(`/get-subsubcategories/?subcategory_id=${subCategoryId}`)
      .then(response => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.json();
      })
      .then(data => {
        subSubCategorySelect.innerHTML = '<option value="">Select</option>';
        data.forEach(item => {
          subSubCategorySelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
        });
      })
      .catch(error => {
        console.error('Error loading sub-subcategories:', error);
        subSubCategorySelect.innerHTML = '<option value="">Error loading</option>';
      });
  });
});

let variantIndex = 1;

function addVariant() {
  const container = document.getElementById('variantContainer');
  const variantDiv = document.createElement('div');
  variantDiv.classList.add('variant-field', 'mb-2');

  variantDiv.innerHTML = `
      <input type="text" name="variants[${variantIndex}][name]" placeholder="Variant (e.g., Half)" >
      <input type="number" name="variants[${variantIndex}][price]" placeholder="Price" step="0.01"  oninput="updateMainPrice()">
      <button type="button" onclick="removeVariant(this)" class="btn btn-danger btn-sm">X</button>
    `;

  container.appendChild(variantDiv);
  variantIndex++;

  updateMainPrice();
}

function removeVariant(button) {
  const field = button.closest('.variant-field');
  field.remove();
  updateMainPrice();
}

// âœ… Auto-update main Price field with lowest variant price
function updateMainPrice() {
  const priceField = document.querySelector("input[name='price']");
  const variantPrices = Array.from(
    document.querySelectorAll("#variantContainer input[name*='[price]']")
  )
  .map(input => parseFloat(input.value) || null)
  .filter(val => val !== null);

  if (variantPrices.length > 0) {
    const minPrice = Math.min(...variantPrices);
    priceField.value = minPrice.toFixed(2);
    priceField.readOnly = true;  // lock when variants exist
  } else {
    priceField.value = "";
    priceField.readOnly = false; // allow typing if no variants
  }
}

function addVoiceNote() {
  const container = document.getElementById('voiceNoteContainer');
  const newEntry = document.createElement('div');
  newEntry.classList.add('voice-note-entry', 'd-flex', 'align-items-start', 'gap-2', 'mb-2');
  newEntry.innerHTML = `
    <div class="flex-grow-1">
      <select name="voiceLanguages[]" class="form-control mb-1" required>
        <option value="">Select Language</option>
        <option value="en">English</option>
        <option value="ml">Malayalam</option>
        <option value="hi">Hindi</option>
        <option value="ar">Arabic</option>
      </select>
      <input type="file" name="voiceFiles[]" class="form-control" accept="audio/*" required>
    </div>
    <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeVoiceNote(this)">âœ–</button>
  `;
  container.appendChild(newEntry);
}

function removeVoiceNote(button) {
  const entry = button.closest('.voice-note-entry');
  entry.remove();
}

function addImageInput() {
  const container = document.getElementById('imageUploadContainer');
  const div = document.createElement('div');
  div.classList.add('image-entry', 'd-flex', 'align-items-center', 'mb-2');
  div.innerHTML = `
      <input type="file" name="dishImages[]" class="form-control me-2" accept="image/*" required>
      <button type="button" class="btn btn-danger btn-sm remove-image" onclick="removeImage(this)">âœ–</button>
    `;
  container.appendChild(div);
}

function removeImage(button) {
  const entry = button.closest('.image-entry');
  entry.remove();
}

function addAddon() {
  const container = document.getElementById('addonContainer');
  const div = document.createElement('div');
  div.classList.add('addon-entry', 'd-flex', 'align-items-center', 'mb-2');
  div.innerHTML = `
      <input type="text" name="addon_name[]" placeholder="Addon Name" class="form-control me-2" />
      <input type="number" name="addon_price[]" placeholder="Price" step="0.01" class="form-control me-2" />
      <input type="file" name="addon_image[]" class="form-control me-2" accept="image/*" />
      <input type="text" name="addon_description[]" placeholder="Description" class="form-control me-2" />
      <button type="button" class="btn btn-danger btn-sm" onclick="removeAddon(this)">âœ–</button>
    `;
  container.appendChild(div);
}

function removeAddon(button) {
  button.closest('.addon-entry').remove();
}
</script>


{% endblock %}
