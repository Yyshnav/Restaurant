{% extends "sidebarman.html" %}
{% block body %}

    <style>
      .table-responsive { overflow-x: auto; }
      .badge { font-size: 1.1rem; padding: 0.5em 1em; color: black; }
      .btn-sm { padding: 0.25rem 0.5rem; transition: transform 0.2s; }
      .btn-sm:hover { transform: scale(1.05); }
      .table-hover tbody tr:hover { background-color: #f1f5f9; transition: background-color 0.3s ease; }
      .filter-btn { margin-right: 0.5rem; }
      .filter-btn.active { background-color: #007bff; color: white; }
      @media (max-width: 768px) {
        .table thead { display: none; }
        .table tr { display: block; margin-bottom: 1rem; border: 1px solid #dee2e6; padding: 1rem; }
        .table td { display: block; text-align: left; }
        .table td::before { content: attr(data-label); font-weight: bold; display: block; }
        .table td:last-child { text-align: center; }
        .filter-btn { display: inline-block; margin-bottom: 0.5rem; }
      }
    </style>
  </head>

  

    <!-- Main Content -->
    <div class="app-content content">
      <div class="content-wrapper">
        <div class="content-header row">
          <div class="content-header-left col-md-6 col-12 mb-2">
            <h3 class="content-header-title text-dark">View Online Orders</h3>
          </div>
          <div class="content-header-right col-md-6 col-12">
            <div class="btn-group float-end" role="group" aria-label="Filter Orders">
              <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">All</button>
              <button type="button" class="btn btn-outline-primary filter-btn" data-filter="pending">Pending</button>
              <button type="button" class="btn btn-outline-primary filter-btn" data-filter="accepted">Accepted</button>
              <button type="button" class="btn btn-outline-primary filter-btn" data-filter="rejected">Rejected</button>
              <button type="button" class="btn btn-outline-primary filter-btn" data-filter="assigned">Assigned</button>
            </div>
          </div>
        </div>

        <div class="content-body">
          <div class="table-responsive">
            <table class="table  table-hover" id="onlineOrdersTable">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="orderTableBody">
                <!-- Orders populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal (Accept/Reject) -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmationModalLabel"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="confirmationMessage"></p>
            <div id="rejectReasonSection" class="mb-3 d-none">
              <label for="rejectReason" class="form-label">Reason for Rejection:</label>
              <textarea class="form-control" id="rejectReason" rows="3" placeholder="Enter reason for rejection"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Assign/Update Delivery Modal -->
    <div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="assignModalLabel">Assign/Update Delivery Boy</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><strong>Order ID:</strong> <span id="assignOrderId"></span></p>
            <div class="mb-3">
              <label for="deliveryBoySelect" class="form-label">Select Delivery Boy:</label>
              <select class="form-select" id="deliveryBoySelect" aria-label="Select Delivery Boy">
                <option value="">Select a Delivery Boy</option>
                <option value="DB001">David Lee</option>
                <option value="DB002">Emma White</option>
                <option value="DB003">Frank Green</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmAssignBtn">Assign</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detailsModalLabel">Order Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><strong>Order ID:</strong> <span id="detailsOrderId"></span></p>
            <p><strong>Customer:</strong> <span id="detailsCustomer"></span></p>
            <p><strong>Address:</strong> <span id="detailsAddress"></span></p>
            <p><strong>Total:</strong> <span id="detailsTotal"></span></p>
            <p><strong>Status:</strong> <span id="detailsStatus"></span></p>
            <p><strong>Date:</strong> <span id="detailsDate"></span></p>
            <p><strong>Rejection Reason:</strong> <span id="detailsRejectReason"></span></p>
            <p><strong>Delivery Boy:</strong> <span id="detailsDeliveryBoy"></span></p>
            <h6>Items Ordered:</h6>
            <ul id="detailsItems" class="list-group">
              <!-- Populated dynamically -->
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Success</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
      </div>
      <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Error</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
      </div>
    </div>

    <!-- JS -->

    <script>
      // Sample order data (replace with API call in production)
      const orders = [
        { id: "O001", customer: "Alice Brown", total: 35.75, status: "pending", date: "2025-07-12", address: "123 Main St, City", items: [{ name: "Pizza Margherita", quantity: 2, price: "$15.00" }, { name: "Coke", quantity: 1, price: "$5.75" }], rejectReason: "", deliveryBoy: "" },
        { id: "O002", customer: "Bob Carter", total: 22.50, status: "accepted", date: "2025-07-11", address: "456 Oak Ave, City", items: [{ name: "Burger", quantity: 1, price: "$10.00" }, { name: "Fries", quantity: 2, price: "$6.25" }], rejectReason: "", deliveryBoy: "" },
        { id: "O003", customer: "Clara Davis", total: 18.00, status: "rejected", date: "2025-07-10", address: "789 Pine Rd, City", items: [{ name: "Salad", quantity: 1, price: "$8.00" }, { name: "Juice", quantity: 1, price: "$10.00" }], rejectReason: "Out of stock", deliveryBoy: "" },
      ];

      // Populate table
      function populateTable() {
        const tbody = $('#orderTableBody');
        tbody.empty();
        orders.forEach(order => {
          const statusClass = {
            pending: 'bg-warning text-dark',
            accepted: 'bg-success text-white',
            rejected: 'bg-danger text-white',
            assigned: 'bg-primary text-white'
          }[order.status] || '';
          const row = `
            <tr>
              <td data-label="Order ID">#${order.id}</td>
              <td data-label="Customer">${order.customer}</td>
              <td data-label="Total">$${order.total.toFixed(2)}</td>
              <td data-label="Status"><span class="badge ">${order.status}</span></td>
              <td data-label="Date">${order.date}</td>
              <td data-label="Actions">
                ${order.status === 'pending' ? `
                  <button class="btn btn-sm btn-success accept-btn" data-id="${order.id}" data-action="accept">Accept</button>
                  <button class="btn btn-sm btn-danger reject-btn" data-id="${order.id}" data-action="reject">Reject</button>
                ` : order.status === 'accepted' || order.status === 'assigned' ? `
                  <button class="btn btn-sm btn-primary assign-btn" data-id="${order.id}" data-bs-toggle="modal" data-bs-target="#assignModal">${order.status === 'assigned' ? 'Update Delivery' : 'Assign Delivery'}</button>
                ` : ''}
                <button class="btn btn-sm btn-info details-btn" data-id="${order.id}" data-bs-toggle="modal" data-bs-target="#detailsModal">Details</button>
              </td>
            </tr>`;
          tbody.append(row);
        });
        updateActions();
      }

      // Filter orders with buttons
      $('.filter-btn').on('click', function () {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        const filter = $(this).data('filter');
        $('#orderTableBody tr').each(function () {
          const status = $(this).find('.badge').text().toLowerCase();
          $(this).toggle(filter === 'all' || filter === status);
        });
      });

      // Show confirmation modal
      function showConfirmation(orderId, action) {
        const modalTitle = $('#confirmationModalLabel');
        const modalMessage = $('#confirmationMessage');
        const rejectReasonSection = $('#rejectReasonSection');
        const confirmButton = $('#confirmActionBtn');
        modalTitle.text(action === 'accept' ? 'Accept Order' : 'Reject Order');
        modalMessage.text(`Are you sure you want to ${action} Order #${orderId}?`);
        rejectReasonSection.toggleClass('d-none', action !== 'reject');
        $('#rejectReason').val('');
        confirmButton.data('id', orderId).data('action', action);
        $('#confirmationModal').modal('show');
      }

      // Handle confirmation
      $('#confirmActionBtn').on('click', function () {
        const orderId = $(this).data('id');
        const action = $(this).data('action');
        const order = orders.find(o => o.id === orderId);
        if (action === 'reject' && !$('#rejectReason').val().trim()) {
          showToast('error', 'Please provide a reason for rejection.');
          return;
        }
        if (action === 'accept') {
          order.status = 'accepted';
          order.rejectReason = '';
          showToast('success', `Order #${orderId} accepted.`);
        } else if (action === 'reject') {
          order.status = 'rejected';
          order.rejectReason = $('#rejectReason').val().trim();
          showToast('success', `Order #${orderId} rejected.`);
        }
        $('#confirmationModal').modal('hide');
        populateTable();
      });

      // Assign/Update delivery boy
      $('#confirmAssignBtn').on('click', function () {
        const orderId = $('#assignOrderId').text().replace('#', '');
        const deliveryBoy = $('#deliveryBoySelect').val();
        if (!deliveryBoy) {
          showToast('error', 'Please select a delivery boy.');
          return;
        }
        const order = orders.find(o => o.id === orderId);
        order.status = 'assigned';
        order.deliveryBoy = $('#deliveryBoySelect option:selected').text();
        showToast('success', `Delivery Boy ${order.deliveryBoy} ${order.status === 'assigned' ? 'updated' : 'assigned'} to Order #${orderId}`);
        $('#assignModal').modal('hide');
        populateTable();
      });

      // Show order details
      function showOrderDetails(orderId) {
        const order = orders.find(o => o.id === orderId) || {};
        $('#detailsOrderId').text(`#${orderId}`);
        $('#detailsCustomer').text(order.customer || 'N/A');
        $('#detailsAddress').text(order.address || 'N/A');
        $('#detailsTotal').text(order.total ? `$${order.total.toFixed(2)}` : 'N/A');
        $('#detailsStatus').text(order.status || 'N/A');
        $('#detailsDate').text(order.date || 'N/A');
        $('#detailsRejectReason').text(order.rejectReason || 'N/A');
        $('#detailsDeliveryBoy').text(order.deliveryBoy || 'N/A');
        $('#detailsItems').empty();
        (order.items || []).forEach(item => {
          $('#detailsItems').append(`<li class="list-group-item">${item.name} (x${item.quantity}) - ${item.price}</li>`);
        });
      }

      // Show toast notification
      function showToast(type, message) {
        const toast = $(`#${type}Toast`);
        toast.find('.toast-body').text(message);
        toast.toast({ delay: 3000 });
        toast.toast('show');
      }

      // Update event listeners
      function updateActions() {
        $('.accept-btn').off('click').on('click', function () {
          showConfirmation($(this).data('id'), 'accept');
        });
        $('.reject-btn').off('click').on('click', function () {
          showConfirmation($(this).data('id'), 'reject');
        });
        $('.assign-btn').off('click').on('click', function () {
          const orderId = $(this).data('id');
          const order = orders.find(o => o.id === orderId);
          $('#assignOrderId').text(`#${orderId}`);
          $('#deliveryBoySelect').val(order.deliveryBoy ? orders.find(o => o.id === orderId).deliveryBoy.split(' ').join('_') : '');
          $('#assignModal').modal('show');
        });
        $('.details-btn').off('click').on('click', function () {
          showOrderDetails($(this).data('id'));
        });
      }

      // Initialize modals and toasts
      $('#assignModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const orderId = button.data('id');
        $(this).find('#assignOrderId').text(`#${orderId}`);
        const order = orders.find(o => o.id === orderId);
        $('#deliveryBoySelect').val(order.deliveryBoy ? order.deliveryBoy.split(' ').join('_') : '');
      });

      $('#detailsModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const orderId = button.data('id');
        showOrderDetails(orderId);
      });

      // Initial setup
      $(document).ready(function () {
        populateTable();
        $('.toast').toast({ animation: true, autohide: true, delay: 3000 });
      });
    </script>

{% endblock %}