{% extends 'sidebarman.html' %}
{% block body %}

<style>
  .table-responsive { overflow-x: auto; }
  .btn-sm { padding: 0.25rem 0.5rem; transition: transform 0.2s; }
  .btn-sm:hover { transform: scale(1.05); }
  .table-hover tbody tr:hover { background-color: #f1f5f9; transition: background-color 0.3s ease; }
  .filter-btn { margin-right: 0.5rem; }
  .filter-btn.active { background-color: #007bff; color: white; }
  #creditUserForm { display: none; }
  #creditUserForm.show { display: block; }
  @media (max-width: 768px) {
    .table thead { display: none; }
    .table tr { display: block; margin-bottom: 1rem; border: 1px solid #dee2e6; padding: 1rem; }
    .table td { display: block; text-align: left; }
    .table td::before { content: attr(data-label); font-weight: bold; display: block; }
    .table td:last-child { text-align: center; }
    .filter-btn { display: inline-block; margin-bottom: 0.5rem; }
  }
</style>

<div class="app-content content">
  <div class="content-wrapper">
    <div class="content-header row">
      <div class="content-header-left col-md-6 col-12 mb-2">
        <h3 class="content-header-title text-dark">Register Credit Users</h3>
      </div>
      <div class="content-header-right col-md-6 col-12">
        <div class="input-group float-end mb-2" style="max-width: 300px;">
          <input type="text" class="form-control" id="searchUsers" placeholder="Search by name, email, or phone">
          <button class="btn btn-outline-primary" type="button" id="addUserBtn">
            <i class="fas fa-plus"></i> Add User
          </button>
        </div>
      </div>
    </div>

    <div class="content-body">
      <!-- Registration Form -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Add New Credit User</h5>
          <form id="creditUserForm" class="row g-3">
            <div class="col-md-6">
              <label for="userName" class="form-label">Name</label>
              <input type="text" class="form-control" id="userName" required>
            </div>
            <div class="col-md-6">
              <label for="userEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="userEmail" required>
            </div>
            <div class="col-md-6">
              <label for="userPhone" class="form-label">Phone</label>
              <input type="tel" class="form-control" id="userPhone" required>
            </div>
            <div class="col-md-6">
              <label for="userAddress" class="form-label">Address</label>
              <input type="text" class="form-control" id="userAddress" required>
            </div>
            <div class="col-md-6">
              <label for="userCreditLimit" class="form-label">Credit Limit</label>
              <input type="number" class="form-control" id="userCreditLimit" required>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">Add User</button>
              <button type="button" class="btn btn-secondary" id="cancelAddBtn">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Users Table -->
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>Email</th><th>Phone</th>
              <th>Address</th><th>Credit Limit</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="successToast" class="toast"><div class="toast-body"></div></div>
  <div id="errorToast" class="toast"><div class="toast-body"></div></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let users = [];

// ✅ Fetch users from backend
function fetchUsers() {
  $.get("/Managerapp/crediusers/?format=json", function(data) {
    users = data.credit_users.map(u => ({
      id: u.id, name: u.Name, email: u.Email,
      phone: u.phone, address: u.address, credit_limit: u.credit_limit
    }));
    populateTable();
  }).fail(err => console.error("Error fetching users:", err));
}

// ✅ Populate table
function populateTable(searchTerm = "") {
  const tbody = $("#usersTableBody");
  tbody.empty();
  const filtered = users.filter(u =>
    u.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    u.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
    u.phone.toLowerCase().includes(searchTerm.toLowerCase())
  );
  filtered.forEach(user => {
    tbody.append(`
      <tr>
        <td>${user.id}</td><td>${user.name}</td><td>${user.email}</td>
        <td>${user.phone}</td><td>${user.address}</td><td>${user.credit_limit}</td>
        <td><button class="btn btn-sm btn-primary">Edit</button></td>
      </tr>
    `);
  });
}

// ✅ Toggle form visibility
$("#addUserBtn").on("click", () => $("#creditUserForm").addClass("show"));
$("#cancelAddBtn").on("click", () => {
  $("#creditUserForm").removeClass("show");
  $("#creditUserForm")[0].reset();
});

// ✅ Add new user with AJAX
$("#creditUserForm").on("submit", function (e) {
  e.preventDefault();

  const Name = $("#userName").val().trim();
  const Email = $("#userEmail").val().trim();
  const phone = $("#userPhone").val().trim();
  const address = $("#userAddress").val().trim();
  const credit_limit = $("#userCreditLimit").val().trim();

  if (!Name || !Email || !phone || !address || !credit_limit) {
    showToast("error", "Please fill all fields");
    return;
  }

  $.ajax({
    url: "/Managerapp/crediusers/",
    type: "POST",
    headers: { "X-CSRFToken": getCookie("csrftoken") },
    data: { Name, Email, phone, address, credit_limit },
    success: function(data) {
      showToast("success", data.message || "User added successfully");
      $("#creditUserForm")[0].reset();
      $("#creditUserForm").removeClass("show");
      fetchUsers();  // ✅ Table updates immediately without reload
    },
    error: function(err) {
      console.error("Error adding user:", err);
      showToast("error", "Failed to add user");
    }
  });
});

// ✅ Toasts
function showToast(type, message) {
  const toast = $(`#${type}Toast`);
  toast.find(".toast-body").text(message);
  toast.toast({ delay: 3000 });
  toast.toast("show");
}

// ✅ CSRF helper
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// ✅ Init
$(document).ready(() => {
  fetchUsers();
  $(".toast").toast({ animation: true, autohide: true, delay: 3000 });
});
</script>
{% endblock %}
