{% extends "sidebarman.html" %}
{% block body %}

    <!-- Main Content -->
    <div class="app-content content">
      <div class="content-wrapper">
        <div class="content-header row">
          <div class="content-header-left col-md-6 col-12 mb-2">
            <h3 class="content-header-title text-dark">Assign Printers to Categories</h3>
          </div>
          <div class="content-header-right col-md-6 col-12">
            <div class="form-group float-right">
              <button class="btn btn-primary" data-toggle="modal" data-target="#addPrinterModal">Add Printer</button>
            </div>
          </div>
        </div>

        <div class="content-body">
          <div class="table-responsive">
            <table class="table table-striped" id="categoriesTable">
              <thead>
                <tr>
                  <th>Category Name</th>
                  <th>Subcategories</th>
                  <th>Assigned Printer</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="categoriesBody">
                <!-- Populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Printer Modal -->
    <div class="modal fade" id="addPrinterModal" tabindex="-1" role="dialog" aria-labelledby="addPrinterModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addPrinterModalLabel">Add New Printer</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="printerId">Printer ID</label>
              <input type="text" class="form-control" id="printerId" required>
            </div>
            <div class="form-group">
              <label for="printerName">Printer Name</label>
              <input type="text" class="form-control" id="printerName" required>
            </div>
            <button class="btn btn-primary" onclick="addPrinter()">Add</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Assign Printer Modal -->
    <div class="modal fade" id="assignPrinterModal" tabindex="-1" role="dialog" aria-labelledby="assignPrinterModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="assignPrinterModalLabel">Assign Printer</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
          </div>
          <div class="modal-body">
            <p><strong>Category/Subcategory:</strong> <span id="categoryNameDetail"></span></p>
            <div class="form-group">
              <label for="printerSelect">Select Printer</label>
              <select class="form-control" id="printerSelect">
                <option value="">Select a Printer</option>
                <!-- Populated dynamically -->
              </select>
            </div>
            <button class="btn btn-primary" onclick="assignPrinter()">Assign</button>
          </div>
        </div>
      </div>
    </div>

    <!-- JS -->


    <script>
      let categories = {
        'Starters': { subcategories: ['Appetizers', 'Soups'], printer: 'P001' },
        'Main Course': { subcategories: ['Vegetarian', 'Non-Vegetarian'], printer: 'P002' },
        'Drinks': { subcategories: [], printer: '' }
      };
      let printers = ['P001', 'P002', 'P003']; // Initial printers

      function renderCategories() {
        const tbody = $('#categoriesBody');
        tbody.empty();
        for (let cat in categories) {
          const row = `<tr>
            <td>${cat}</td>
            <td>${categories[cat].subcategories.join(', ') || 'None'}</td>
            <td>${categories[cat].printer || 'Not Assigned'}</td>
            <td><button class="btn btn-sm btn-info assign-printer-btn" data-category="${cat}">Assign Printer</button></td>
          </tr>`;
          tbody.append(row);
          categories[cat].subcategories.forEach(sub => {
            const subRow = `<tr>
              <td style="padding-left: 20px;">${sub} (Subcategory)</td>
              <td></td>
              <td>${categories[cat].printer || 'Inherits Parent'}</td>
              <td><button class="btn btn-sm btn-info assign-printer-btn" data-category="${sub}" data-parent="${cat}">Assign Printer</button></td>
            </tr>`;
            tbody.append(subRow);
          });
        }
        updateActions();
      }

      function updatePrinterDropdown() {
        const select = $('#printerSelect');
        select.empty();
        select.append('<option value="">Select a Printer</option>');
        printers.forEach(printer => {
          select.append(`<option value="${printer}">${printer}</option>`);
        });
      }

      function addPrinter() {
        const id = $('#printerId').val();
        const name = $('#printerName').val();
        if (id && name && !printers.includes(id)) {
          printers.push(id);
          alert(`Printer ${id} (${name}) added successfully.`);
          $('#addPrinterModal').modal('hide');
          $('#printerId').val('');
          $('#printerName').val('');
          updatePrinterDropdown();
        } else {
          alert('Please enter a unique Printer ID and Name.');
        }
      }

      function assignPrinter() {
        const category = $('#categoryNameDetail').data('category');
        const parent = $('#categoryNameDetail').data('parent');
        const printer = $('#printerSelect').val();
        if (printer) {
          if (parent) {
            // For subcategories, assign printer directly (adjust if inheritance is preferred)
            if (!categories[parent].subcategories.some(sub => sub.name === category)) {
              categories[parent].subcategories = categories[parent].subcategories.map(sub => 
                sub === category ? { name: sub, printer } : sub);
            }
          } else {
            categories[category].printer = printer;
          }
          alert(`Printer ${printer} assigned to ${category}${parent ? ' (subcategory)' : ''}`);
          $('#assignPrinterModal').modal('hide');
          renderCategories();
        } else {
          alert('Please select a printer.');
        }
      }

      function updateActions() {
        $('.assign-printer-btn').off('click').on('click', function () {
          const category = $(this).data('category');
          const parent = $(this).data('parent');
          $('#categoryNameDetail').text(category + (parent ? ' (Subcategory of ' + parent + ')' : ''))
                                   .data('category', category)
                                   .data('parent', parent);
          $('#assignPrinterModal').modal('show');
        });
      }

      // Initial setup
      $(document).ready(function () {
        renderCategories();
        updatePrinterDropdown();
      });
    </script>
{% endblock %}